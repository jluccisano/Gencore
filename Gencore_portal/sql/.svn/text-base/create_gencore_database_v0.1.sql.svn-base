-- phpMyAdmin SQL Dump
-- version 3.2.0.1
-- http://www.phpmyadmin.net
--
-- Serveur: localhost
-- Généré le : Sam 16 Octobre 2010 à 11:36
-- Version du serveur: 5.1.36
-- Version de PHP: 5.3.0

SET SQL_MODE="NO_AUTO_VALUE_ON_ZERO";

--
-- Base de données: `gencore_db`
--

-- --------------------------------------------------------

--
-- Structure de la table `t_role`
--

CREATE TABLE IF NOT EXISTS `T_ROLE` (
  `ID` bigint(20) NOT NULL AUTO_INCREMENT,
  `NAME` varchar(255) DEFAULT NULL,
  PRIMARY KEY (`ID`),
  UNIQUE KEY `NAME` (`NAME`)
) ENGINE=InnoDB  DEFAULT CHARSET=latin1 AUTO_INCREMENT=8 ;

-- --------------------------------------------------------

--
-- Structure de la table `t_user`
--

CREATE TABLE IF NOT EXISTS `T_USER` (
  `ID` bigint(20) NOT NULL AUTO_INCREMENT,
  `LOGIN` varchar(255) DEFAULT NULL,
  `EMAIL` varchar(255) DEFAULT NULL,
  `PASSWORD` blob NOT NULL,
  `ENABLED` bit(1) DEFAULT NULL,
  `FIRSTNAME` varchar(255) DEFAULT NULL,
  `LASTNAME` varchar(255) DEFAULT NULL,
  `LANGUAGE` integer DEFAULT NULL,
  `CREATION_DATE` datetime DEFAULT NULL,
  `LASTACCESS_DATE` datetime DEFAULT NULL,
  `LOCKED` bit(1) DEFAULT NULL,
  `ROLE_ID` bigint(20) DEFAULT NULL,
  `PHOTO` blob DEFAULT NULL,
  PRIMARY KEY (`ID`),
  UNIQUE KEY `LOGIN` (`LOGIN`),
  UNIQUE KEY `EMAIL` (`EMAIL`)
) ENGINE=InnoDB  DEFAULT CHARSET=latin1 AUTO_INCREMENT=1;

--
-- Structure de la table `T_GPSLOCATION`
--

CREATE TABLE IF NOT EXISTS `T_GPSLOCATION` (
  `ID` bigint(20) NOT NULL AUTO_INCREMENT,
  `LATTITUDE` double DEFAULT NULL,
  `LONGITUDE` double DEFAULT NULL,
  `ALTITUDE` bigint(20) DEFAULT NULL,
  `ACQUISITION_DATE` datetime DEFAULT NULL,
  `ITINARYNAME` varchar(255) DEFAULT NULL,
  `STATUS` integer DEFAULT NULL,
  `COURSE` bigint(20) NOT NULL,
  PRIMARY KEY (`ID`)
) ENGINE=InnoDB DEFAULT CHARSET=latin1 AUTO_INCREMENT=1 ;


--
-- Structure de la table `T_DEVICE`
--

CREATE TABLE IF NOT EXISTS `T_DEVICE` (
  `ID` bigint(20) NOT NULL AUTO_INCREMENT,
  `IMEI` varchar(255) NOT NULL,
  `USER` bigint(20) NOT NULL,
  PRIMARY KEY (`ID`)
) ENGINE=InnoDB DEFAULT CHARSET=latin1 AUTO_INCREMENT=1 ;


--
-- Structure de la table `T_RUN`
--


CREATE TABLE IF NOT EXISTS `T_COURSE` (
  `ID` bigint(20) NOT NULL AUTO_INCREMENT,
  `COURSE_ID` varchar(255) NOT NULL,
  `COURSE_TYPE_ID` bigint(20) DEFAULT NULL,
  `START_DATE` datetime DEFAULT NULL,
  `END_DATE` datetime DEFAULT NULL,
  `DISTANCE` double DEFAULT NULL,
  `SPEED_AVERAGE` double DEFAULT NULL,
  `KM_AVERAGE` double DEFAULT NULL,
  `STATUS` integer DEFAULT NULL,
  `USER` bigint(20) DEFAULT NULL,
  `START_LOCATION` bigint(20) DEFAULT NULL,
  PRIMARY KEY (`ID`)
) ENGINE=InnoDB DEFAULT CHARSET=latin1 AUTO_INCREMENT=1 ;
--
-- Contraintes pour les tables exportées
--

CREATE TABLE IF NOT EXISTS `T_COURSE_TYPE` (
  `ID` bigint(20) NOT NULL AUTO_INCREMENT,
  `NAME` varchar(255) NOT NULL,
  PRIMARY KEY (`ID`)
) ENGINE=InnoDB DEFAULT CHARSET=latin1 AUTO_INCREMENT=1 ;

--
-- Contraintes pour la table `t_user`
--
ALTER TABLE `T_USER`
  ADD CONSTRAINT `USER_ROLE_FK` FOREIGN KEY (`ROLE_ID`) REFERENCES `T_ROLE` (`ID`);
  
ALTER TABLE `T_COURSE`
  ADD CONSTRAINT `COURSE_USER_FK` FOREIGN KEY (`USER`) REFERENCES `T_USER` (`ID`);
  
ALTER TABLE `T_COURSE`
  ADD CONSTRAINT `COURSE_GPSLOCATION_FK` FOREIGN KEY (`START_LOCATION`) REFERENCES `T_GPSLOCATION` (`ID`);

ALTER TABLE `T_COURSE`
  ADD CONSTRAINT `COURSE_COURSE_TYPE_FK` FOREIGN KEY (`COURSE_TYPE_ID`) REFERENCES `T_COURSE_TYPE` (`ID`);
  
ALTER TABLE `T_DEVICE`
  ADD CONSTRAINT `DEVICE_USER_FK` FOREIGN KEY (`USER`) REFERENCES `T_USER` (`ID`);
  
ALTER TABLE `T_GPSLOCATION`
  ADD CONSTRAINT `GPSLOCATION_COURSE_FK` FOREIGN KEY (`COURSE`) REFERENCES `T_COURSE` (`ID`);
  

CREATE VIEW TOTAL_STATS(TYPE,TOTAL_DISTANCE) 
AS 
SELECT "Cycling", sum(DISTANCE)  FROM T_COURSE course
WHERE COURSE_TYPE_ID = 0
UNION
SELECT "Running", sum(DISTANCE)  FROM T_COURSE course
WHERE COURSE_TYPE_ID = 1
UNION
SELECT "Walking", sum(DISTANCE)  FROM T_COURSE course
WHERE COURSE_TYPE_ID = 2


